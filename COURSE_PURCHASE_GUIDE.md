# Course Purchase Flow Guide

This guide explains how the course purchasing system works and how to test it.

## üîÑ Complete Purchase Flow

### 1. **User Journey**
1. User visits a course page (`/courses/[courseId]`)
2. User clicks "Buy Course" or "Enroll" button
3. User is redirected to checkout page (`/checkout/[courseId]`)
4. User fills out customer information and agrees to terms
5. User clicks "Pay with QPay" button
6. QPay invoice is created and QR code is displayed
7. User scans QR code with bank app and completes payment
8. QPay webhook notifies our system of payment
9. Course access is granted to user
10. User can now access the course content

### 2. **Technical Flow**

```
Frontend (Checkout) ‚Üí QPay API ‚Üí Bank App ‚Üí QPay Webhook ‚Üí Course Access
     ‚Üì                    ‚Üì           ‚Üì           ‚Üì            ‚Üì
  User Info         Invoice Creation  Payment   Payment      Access
  Collection        QR Code Display   Process   Verification  Grant
```

## üß™ Testing the Purchase Flow

### **Option 1: Mock Testing (Recommended for Development)**

1. **Start the development server:**
   ```bash
   npm run dev
   ```

2. **Test the complete flow:**
   ```bash
   npm run test:purchase
   ```

3. **Manual testing:**
   - Go to any course page
   - Click "Buy Course"
   - Fill out the checkout form
   - Click "Pay with QPay"
   - Use the "Mark as Paid" button for testing
   - Verify course access is granted

### **Option 2: Real QPay Testing**

1. **Set up QPay credentials** (see `QPAY_REAL_SETUP.md`)

2. **Configure environment variables:**
   ```bash
   # In .env.local
   QPAY_MOCK_MODE=false
   QPAY_BASE_URL=https://merchant-sandbox.qpay.mn
   QPAY_CLIENT_ID=your_client_id
   QPAY_CLIENT_SECRET=your_client_secret
   QPAY_USERNAME=your_username
   QPAY_PASSWORD=your_password
   QPAY_INVOICE_CODE=your_invoice_code
   QPAY_WEBHOOK_PUBLIC_URL=https://your-domain.com/api/pay/qpay/webhook
   ```

3. **Test with real QPay:**
   ```bash
   npm run qpay:test
   ```

## üîß Key Components

### **Frontend Components**
- `app/checkout/[courseId]/page.tsx` - Checkout page with customer form
- `components/PayWithQPay.tsx` - QPay payment component
- `components/QRCodeDisplay.tsx` - QR code display component

### **API Endpoints**
- `POST /api/pay/qpay/create` - Create QPay invoice
- `POST /api/pay/qpay/status` - Check payment status
- `POST /api/pay/qpay/webhook` - QPay payment webhook
- `GET /api/user/enrolled-courses` - Get user's enrolled courses

### **Database Models**
- `Order` - Stores payment orders and QPay data
- `CourseAccess` - Manages course access permissions
- `Course` - Course information
- `User` - User information

## üêõ Troubleshooting

### **Common Issues**

1. **QR Code not displaying:**
   - Check if `qrcode` package is installed
   - Verify QR text is being generated by QPay API
   - Check browser console for errors

2. **Payment not completing:**
   - Check QPay credentials are correct
   - Verify webhook URL is publicly accessible
   - Check order status in database

3. **Course access not granted:**
   - Check if `CourseAccess.grantAccess()` is being called
   - Verify user ID matches between order and access record
   - Check enrolled courses API response

4. **Mock payments auto-completing:**
   - This is disabled by default in the current implementation
   - Use "Mark as Paid" button for manual testing

### **Debug Tools**

1. **Check course access:**
   ```bash
   curl "http://localhost:3000/api/debug/course-access?userId=test-user&courseId=course-id"
   ```

2. **View enrolled courses:**
   ```bash
   curl "http://localhost:3000/api/user/enrolled-courses?email=user@example.com"
   ```

3. **Check QPay status:**
   ```bash
   npm run qpay:check
   ```

## üìä Database Queries

### **Check User's Orders**
```javascript
// In MongoDB shell or script
db.orders.find({ userId: "user-id" }).sort({ createdAt: -1 })
```

### **Check Course Access**
```javascript
db.courseaccesses.find({ userId: "user-id", courseId: ObjectId("course-id") })
```

### **Check QPay Data**
```javascript
db.orders.find({ "qpay.invoiceId": { $exists: true } })
```

## üöÄ Production Deployment

1. **Set up real QPay credentials**
2. **Configure webhook URL** to point to your production domain
3. **Test webhook** with QPay's test environment
4. **Monitor logs** for payment processing
5. **Set up error alerts** for failed payments

## üìù Notes

- The system supports both mock and real QPay integration
- Course access is managed through the `CourseAccess` model
- Orders are stored with complete QPay transaction data
- Webhook processing is idempotent to prevent duplicate processing
- User authentication is required for all purchase operations

## üîó Related Files

- `QPAY_REAL_SETUP.md` - QPay integration setup
- `scripts/test-course-purchase.ts` - Purchase flow test
- `scripts/qpay-real-test.ts` - QPay API test
- `lib/qpay/` - QPay integration library
- `lib/models/` - Database models
